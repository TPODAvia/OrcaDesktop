<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Robots Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <!-- If you already have a global stylesheet, this will still work with it -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
      :root{
        --ok:#2ecc71;
        --stale:#f39c12;
        --err:#e74c3c;
        --muted: #8a8f98;
        --border: #2a2f36;
        --bg2:#12151a;
      }
      body { background:#0f1115; color:#e9eef5; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
      .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
      h1{ margin: 0 0 12px 0; font-size:20px; font-weight:700; }
      .flex{ display:flex; gap:12px; align-items:flex-start; }
      .col{ display:flex; flex-direction:column; gap:12px; }
      .left{ width: 360px; }
      .right{ min-width: 0; flex:1; }
      .card{ background:#11151b; border:1px solid var(--border); border-radius:12px; padding:12px; }
      .row{ display:flex; gap:10px; align-items:center; }
      .between{ display:flex; justify-content:space-between; align-items:center; }
      .grid{ display:grid; grid-template-columns: repeat(2, minmax(260px, 1fr)); gap:12px; }
      @media (max-width: 980px){ .flex{ flex-direction:column; } .left{ width:auto; } .grid{ grid-template-columns: 1fr; } }

      .caps{ text-transform: uppercase; letter-spacing:.04em; font-size:.75rem; color:var(--muted); }
      .muted{ color:var(--muted); }
      .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
      .nowrap{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

      /* Namespace list */
      #nsList{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
      .item{ padding:8px 10px; border:1px solid var(--border); border-radius:10px; cursor:pointer; background:#0f141a; }
      .item:hover{ border-color:#324b61; background:#0f151d; }
      .item.sel{ border-color:#2f6b45; box-shadow:0 0 0 2px rgba(47,107,69,.2) inset; }
      .ns-title{ font-weight:700; font-size:0.95rem; }
      .pill{ font-size:.70rem; padding:2px 8px; border-radius:999px; border:1px solid var(--border); }
      .badge{ font-size:.72rem; padding:2px 8px; border-radius:6px; border:1px solid var(--border); background:#0e1217; }
      .badge.ok{ border-color: rgba(46,204,113,.35); color: var(--ok); }
      .badge.stale{ border-color: rgba(243,156,18,.35); color: var(--stale); }
      .badge.err{ border-color: rgba(231,76,60,.35); color: var(--err); }

      /* Inputs / buttons */
      .search{ width:100%; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#0e1217; color:#e9eef5; }
      button{ appearance:none; border:1px solid var(--border); background:#0e1217; color:#e9eef5; padding:8px 10px; border-radius:10px; cursor:pointer; }
      button:hover{ border-color:#2a5bfa55; }
      button.ghost{ background:transparent; }
      a{ color:#9cc2ff; text-decoration:none; }
      a:hover{ text-decoration:underline; }

      /* Data blocks */
      .kv{ display:grid; grid-template-columns: 120px 1fr; gap:6px 12px; align-items:start; }
      .code{ background:#0b0f14; border:1px solid var(--border); border-radius:10px; padding:10px; max-height:320px; overflow:auto; }
      .imgbox{ display:flex; justify-content:center; align-items:center; background:#0b0f14; border:1px solid var(--border); border-radius:10px; min-height:220px; }
      .imgbox img{ max-width:100%; height:auto; display:block; border-radius:8px; }

      /* Tiny status dot */
      .dot{ width:9px; height:9px; border-radius:50%; display:inline-block; margin-right:6px; background:var(--stale); box-shadow:0 0 0 0 rgba(46,204,113,0); }
      .dot.ok{ background:var(--ok); animation:pulse 2s ease-out infinite; }
      @keyframes pulse{ 0%{ box-shadow:0 0 0 0 rgba(46,204,113,.6) } 70%{ box-shadow:0 0 0 12px rgba(46,204,113,0)} 100%{ box-shadow:0 0 0 0 rgba(46,204,113,0)} }

      .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
      .small{ font-size:.82rem; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Robots Dashboard</h1>
      <div class="flex">
        <!-- LEFT: robot list / picker -->
        <div class="col left">
          <div class="card">
            <div class="between">
              <div><span class="caps">Namespaces</span></div>
              <div class="muted small"><span id="nsCount">0</span> found</div>
            </div>
            <div class="toolbar" style="margin-top:8px">
              <input id="nsSearch" class="search" placeholder="Filter robots… (by namespace)"/>
              <label class="small"><input type="checkbox" id="showOnlyLive" style="vertical-align:middle; margin-right:6px">only live</label>
            </div>
            <div id="nsList"></div>
            <div class="row" style="justify-content:space-between; margin-top:8px">
              <div class="muted small">Auto-refresh</div>
              <div class="small"><span id="lastNsRefresh" class="muted">never</span></div>
            </div>
          </div>
        </div>

        <!-- RIGHT: detail view -->
        <div class="col fill right">
          <div class="card">
            <div class="between">
              <div>
                <div class="caps">Selected</div>
                <div id="selNs" class="mono">—</div>
                <div class="small muted">Last heard: <span id="selAge">—</span></div>
              </div>
              <div class="toolbar">
                <a id="openViz" href="#" target="_blank" class="small">Open Visualizer →</a>
                <button id="refreshNow" class="ghost small">Refresh now</button>
              </div>
            </div>
          </div>

          <div class="grid">
            <!-- STATE -->
            <div class="card">
              <div class="between" style="margin-bottom:8px;">
                <h2 style="margin:0;font-size:1rem;">State</h2>
                <span id="liveBadge" class="badge">—</span>
              </div>
              <div class="kv">
                <div>Time</div><div id="stTime">—</div>
                <div>Pose</div><div id="stPose" class="mono">—</div>
                <div>Yaw</div><div id="stYaw" class="mono">—</div>
                <div>Path</div><div id="stPath" class="mono muted">—</div>
              </div>
            </div>

            <!-- DIAGNOSTICS -->
            <div class="card">
              <div class="between" style="margin-bottom:8px;">
                <h2 style="margin:0;font-size:1rem;">Diagnostics</h2>
                <div class="toolbar">
                  <button id="diagCopy" class="small">Copy</button>
                  <label class="small"><input type="checkbox" id="diagWrap" style="vertical-align:middle; margin-right:6px" checked>wrap</label>
                </div>
              </div>
              <pre id="diagBox" class="code" style="white-space: pre-wrap;">N/A</pre>
            </div>

            <!-- CAMERA -->
            <div class="card" style="grid-column: 1 / -1;">
              <div class="between" style="margin-bottom:8px;">
                <h2 style="margin:0;font-size:1rem;">Camera</h2>
                <div class="toolbar">
                  <span id="camStatus" class="small muted">stopped</span>
                  <button id="camPlay" class="small">Play</button>
                  <button id="camStop" class="small">Stop</button>
                </div>
              </div>
              <div class="imgbox"><img id="camImg" alt="camera stream"/></div>
              <div class="row" style="margin-top:8px; justify-content:space-between;">
                <div class="small muted">Refresh ~2 Hz • <span id="camFps" class="small muted">— fps</span></div>
                <a id="openImage" class="small" href="#" target="_blank">Open image in new tab</a>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- /flex -->
    </div>

    <script>
      // ------------------ STATE ------------------
      let ACTIVE_NS = null;
      let NS_CACHE = [];
      let camTimer = null;
      let camLastTick = 0, camFrames = 0, camFpsTimer = null;

      const $ = (id) => document.getElementById(id);

      // ------------------ HELPERS ------------------
      function queryParam(name){
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }
      function setQueryParam(name, val){
        const u = new URL(window.location.href);
        if (val) u.searchParams.set(name, val); else u.searchParams.delete(name);
        window.history.replaceState({}, '', u.toString());
      }
      function fmtNum(v, d=2){ const n = Number(v); return Number.isFinite(n) ? n.toFixed(d) : '—'; }
      function fmtAge(sec){
        if (sec == null) return '—';
        if (sec < 1) return `${(sec*1000|0)} ms`;
        if (sec < 60) return `${sec.toFixed(1)} s`;
        const m = Math.floor(sec/60), s = Math.floor(sec%60);
        return `${m}m ${s}s`;
      }
      function nowLocalString(){
        const d = new Date();
        return d.toLocaleString();
      }
      function isLive(age){
        return age !== null && age < 3.0;
      }

      function setLinks(){
        const host = window.location.hostname;
        const a = $('openViz');
        a.href = ACTIVE_NS ? `http://${host}:8080/?ns=${encodeURIComponent(ACTIVE_NS)}` : '#';
        const imgA = $('openImage');
        imgA.href = ACTIVE_NS ? `/api/robot/${encodeURIComponent(ACTIVE_NS)}/image` : '#';
      }

      // ------------------ NAMESPACES LIST ------------------
      function nsItem(node){
        const age = node.age;
        const live = isLive(age);
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <div class="ns-title nowrap"><span class="dot ${live?'ok':''}"></span>${node.ns}</div>
            <div class="row">
              <span class="badge ${live ? 'ok' : 'stale'}">${live ? 'live' : 'stale'}</span>
            </div>
          </div>
          <div class="row" style="justify-content:space-between; margin-top:6px;">
            <div class="muted small">age: ${fmtAge(age)}</div>
            <div class="muted small mono">pose: ${
              node.pose ? `x:${fmtNum(node.pose.x)} y:${fmtNum(node.pose.y)}` : '—'
            }</div>
          </div>
        `;
        el.addEventListener('click', () => {
          pickNs(node.ns);
          [...el.parentNode.children].forEach(x => x.classList.remove('sel'));
          el.classList.add('sel');
        });
        if (ACTIVE_NS === node.ns) el.classList.add('sel');
        return el;
      }

      function filterAndSort(arr){
        const q = $('nsSearch').value.trim().toLowerCase();
        const liveOnly = $('showOnlyLive').checked;
        return arr
          .filter(r => (!q || String(r.ns).toLowerCase().includes(q)) && (!liveOnly || isLive(r.age)))
          .sort((a,b) => {
            const la = isLive(a.age), lb = isLive(b.age);
            if (la !== lb) return la ? -1 : 1; // live first
            return String(a.ns).localeCompare(String(b.ns));
          });
      }

      async function loadNsList(){
        try{
          const res = await fetch('/api/robots', { cache:'no-store' });
          const arr = await res.json();
          if (!Array.isArray(arr)) throw new Error('bad payload');
          NS_CACHE = arr;
          $('nsCount').textContent = arr.length;
          $('lastNsRefresh').textContent = nowLocalString();

          const box = $('nsList'); box.innerHTML = '';
          const filtered = filterAndSort(arr);
          if (!filtered.length){ box.textContent = 'No robots found.'; return; }
          filtered.forEach(r => box.appendChild(nsItem(r)));

          // Initial selection from ?ns= or localStorage, else first live
          if (!ACTIVE_NS){
            const fromUrl = queryParam('ns');
            const fromLocal = localStorage.getItem('dash.sel_ns');
            const pick = filtered.find(r => r.ns === fromUrl)
                      || filtered.find(r => r.ns === fromLocal)
                      || filtered.find(r => isLive(r.age))
                      || filtered[0];
            if (pick) pickNs(pick.ns);
          }else{
            // update selected age in header
            const cur = arr.find(r => r.ns === ACTIVE_NS);
            $('selAge').textContent = cur ? fmtAge(cur.age) : '—';
          }
        }catch(e){
          $('nsList').textContent = 'Failed to fetch namespaces.';
        }
      }

      // ------------------ PICK / SELECT ROBOT ------------------
      async function pickNs(ns){
        ACTIVE_NS = ns;
        localStorage.setItem('dash.sel_ns', ns);
        $('selNs').textContent = ns || '—';
        const cur = NS_CACHE.find(r => r.ns === ns);
        $('selAge').textContent = cur ? fmtAge(cur.age) : '—';
        setLinks();
        setQueryParam('ns', ns || '');
        await Promise.all([refreshState(), refreshDiagnostics()]);
        restartCam(true); // auto-play camera on selection
      }

      // ------------------ STATE & PATH ------------------
      async function refreshState(){
        if (!ACTIVE_NS) return;
        try{
          // State (pose/yaw/time)
          const j = await (await fetch('/api/status?ns=' + encodeURIComponent(ACTIVE_NS), { cache:'no-store' })).json();

          const ok = j && j.ok;
          $('liveBadge').className = `badge ${ok ? 'ok' : 'stale'}`;
          $('liveBadge').textContent = ok ? 'live' : 'stale';

          if (ok){
            $('stPose').textContent = `x:${fmtNum(j.x)}  y:${fmtNum(j.y)}`;
            $('stYaw').textContent  = `${fmtNum(j.yaw, 3)} rad`;
            const ts = j.t ? new Date(j.t * 1000) : new Date();
            $('stTime').textContent = ts.toLocaleString();
          }else{
            $('stPose').textContent = '—';
            $('stYaw').textContent  = '—';
            $('stTime').textContent = '—';
          }

          // Path preview (from /api/robots list cache)
          const cur = NS_CACHE.find(r => r.ns === ACTIVE_NS);
          $('stPath').textContent = (cur && Array.isArray(cur.path) && cur.path.length)
              ? cur.path.join(' → ')
              : '—';

          // Update header age
          if (cur) $('selAge').textContent = fmtAge(cur.age);
        }catch{
          $('liveBadge').className = 'badge err';
          $('liveBadge').textContent = 'error';
        }
      }

      // ------------------ DIAGNOSTICS ------------------
      async function refreshDiagnostics(){
        if (!ACTIVE_NS) return;
        try{
          const res = await fetch(`/api/robot/${encodeURIComponent(ACTIVE_NS)}/diagnostics`, { cache:'no-store' });
          if (!res.ok){ $('diagBox').textContent = 'N/A'; return; }
          let txt = await res.text();
          // keep diagnostics from exploding the page
          if (txt.length > 20000) txt = txt.slice(-20000);
          $('diagBox').textContent = txt || 'N/A';
        }catch{
          $('diagBox').textContent = 'N/A';
        }
      }

      $('diagCopy').addEventListener('click', async () => {
        try{
          await navigator.clipboard.writeText($('diagBox').textContent || '');
          $('diagCopy').textContent = 'Copied ✓';
          setTimeout(()=> $('diagCopy').textContent = 'Copy', 1000);
        }catch{
          $('diagCopy').textContent = 'Failed';
          setTimeout(()=> $('diagCopy').textContent = 'Copy', 1000);
        }
      });
      $('diagWrap').addEventListener('change', (e)=>{
        $('diagBox').style.whiteSpace = e.target.checked ? 'pre-wrap' : 'pre';
      });

      // ------------------ CAMERA ------------------
      function updateCamFps(){
        const now = performance.now();
        if (!camLastTick){ camLastTick = now; camFrames = 0; }
        camFrames++;
      }
      function startFpsCounter(){
        stopFpsCounter();
        camFpsTimer = setInterval(()=>{
          const fps = camFrames / 2; // approx since we reset every 2s below
          $('camFps').textContent = Number.isFinite(fps) ? `${fps.toFixed(1)} fps` : '— fps';
          camFrames = 0;
        }, 2000);
      }
      function stopFpsCounter(){
        clearInterval(camFpsTimer); camFpsTimer = null;
        $('camFps').textContent = '— fps';
      }

      function restartCam(play=true){
        clearInterval(camTimer); camTimer = null;
        const img = $('camImg');
        img.src=''; // clear
        if (!ACTIVE_NS || !play){
          $('camStatus').textContent = 'stopped';
          stopFpsCounter();
          return;
        }
        const urlBase = `/api/robot/${encodeURIComponent(ACTIVE_NS)}/image`;
        function tick(){
          // cache-busting query
          img.src = `${urlBase}?_=${Date.now()}`;
        }
        img.onload = () => { updateCamFps(); };
        img.onerror = () => { /* ignore single errors while polling */ };
        $('camStatus').textContent = 'playing';
        startFpsCounter();
        tick();
        camTimer = setInterval(tick, 500); // ~2 Hz
      }

      $('camPlay').addEventListener('click', ()=> restartCam(true));
      $('camStop').addEventListener('click', ()=> restartCam(false));

      // ------------------ WIRING / POLLING ------------------
      $('nsSearch').addEventListener('input', () => loadNsList());
      $('showOnlyLive').addEventListener('change', () => loadNsList());
      $('refreshNow').addEventListener('click', async () => {
        await loadNsList();
        await Promise.all([refreshState(), refreshDiagnostics()]);
      });

      // initial bootstrap
      loadNsList();
      setInterval(loadNsList, 2000);
      setInterval(refreshState, 1000);
      setInterval(refreshDiagnostics, 3000);
    </script>
  </body>
</html>
