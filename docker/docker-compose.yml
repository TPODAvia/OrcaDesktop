services:
  zenohd:
    image: eclipse/zenoh:latest
    container_name: zenohd
    network_mode: host
    command: >
      -c /etc/zenoh/router.json5
    volumes:
      - ./zenoh/router.json5:/etc/zenoh/router.json5:ro
    restart: unless-stopped

  zenoh_bridge_ros2dds:
    image: eclipse/zenoh-bridge-ros2dds:latest
    container_name: zenoh-bridge-ros2dds
    network_mode: host
    depends_on:
      - zenohd
    environment:
      RMW_IMPLEMENTATION: rmw_cyclonedds_cpp
      ROS_DISTRO: humble
    command: >
      -c /etc/zenoh/bridge-dds.json5
    volumes:
      - ./zenoh/bridge-dds.json5:/etc/zenoh/bridge-dds.json5:ro
    restart: unless-stopped

  ros2_cli:
    image: ros:humble-ros-core
    container_name: ros2-cli
    network_mode: host
    depends_on:
      - zenohd
      - zenoh_bridge_ros2dds
    tty: true
    stdin_open: true
    working_dir: /root/colcon_ws
    volumes:
      - ../colcon_ws:/root/colcon_ws
    environment:
      DEBIAN_FRONTEND: noninteractive
      ROS_DISTRO: humble
      ROS_DOMAIN_ID: "41"
      RMW_IMPLEMENTATION: rmw_cyclonedds_cpp
      INFLUX_URL: "http://127.0.0.1:8086"
      INFLUX_TOKEN: ${INFLUX_TOKEN:-supersecrettoken}
      INFLUX_ORG: ${INFLUX_ORG:-orca}
      INFLUX_BUCKET: ${INFLUX_BUCKET:-rmf}
      MEASUREMENT: rmf_robot_state
    command:
      - bash
      - -lc
      - |
        set -e
        apt-get update
        # Minimal system tooling
        apt-get install -y --no-install-recommends build-essential cmake git \
          python3-rosdep python3-colcon-common-extensions python3-vcstool \
          python3-pip
        # RMW CycloneDDS (rosdep won't install RMW selection)
        apt-get install -y --no-install-recommends ros-$ROS_DISTRO-rmw-cyclonedds-cpp
        # Python deps via pip (from your package.xml)
        python3 -m pip install --no-cache-dir pyyaml Flask waitress influxdb_client
        sudo apt install -y ros-humble-cv-bridge python3-opencv ros-humble-nav-msgs ros-humble-sensor-msgs
        # rosdep for ROS package dependencies in your workspace
        rosdep init || true
        rosdep update || true
        if [ -d src ]; then
          rosdep install --rosdistro $ROS_DISTRO --from-paths src --ignore-src -yr || true
        fi
        # Auto-source ROS & workspace for every shell
        echo "source /opt/ros/$ROS_DISTRO/setup.bash" >> /root/.bashrc
        echo "[ -f /root/colcon_ws/install/setup.bash ] && source /root/colcon_ws/install/setup.bash" >> /root/.bashrc
        echo "✅ Dev shell ready at /root/colcon_ws (ROS_DOMAIN_ID=$ROS_DOMAIN_ID)"
        exec bash -l
    restart: "no"

  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    network_mode: host
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USERNAME:-admin}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD:-admin12345}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUX_ORG:-orca}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUX_BUCKET:-rmf}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUX_TOKEN:-supersecrettoken}
    volumes:
      - ./influxdb/data:/var/lib/influxdb2
      - ./influxdb/config:/etc/influxdb2
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:8086/health"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 30s
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.4.5
    container_name: grafana
    network_mode: host
    depends_on:
      - influxdb
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - ./grafana/data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    restart: unless-stopped

  # zoneminder:
  #   build:
  #     context: ./zoneminder
  #   container_name: zoneminder
  #   shm_size: "512m"
  #   ports:
  #     - "8080:80"
  #   volumes:
  #     - /mnt/zm_sda1/events:/var/cache/zoneminder/events
  #     - /mnt/zm_sda1/images:/var/cache/zoneminder/images
  #     - /mnt/zm_sda1/logs:/var/log/zm
  #   restart: unless-stopped

  go2rtc:
    image: ghcr.io/alexxit/go2rtc:latest
    container_name: go2rtc
    network_mode: host        # easiest in your setup, like zenohd etc.
    restart: unless-stopped
    volumes:
      - ./go2rtc/go2rtc.yaml:/config/go2rtc.yaml:ro

  frigate:
    container_name: frigate
    image: ghcr.io/blakeblackshear/frigate:stable-tensorrt
    privileged: true
    restart: unless-stopped
    shm_size: "2g"
    network_mode: host

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    environment:
      NVIDIA_VISIBLE_DEVICES: "all"
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility,video"

    devices:
      - /dev/bus/usb:/dev/bus/usb   # если нужен Coral, можно убрать
      - /dev/dri:/dev/dri           # hw-accel видео

    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./frigate/config.yml:/config/config.yml:ro
      - ./frigate/storage:/media/frigate
      - ./frigate/models:/config/models
      - type: tmpfs
        target: /tmp/cache
        tmpfs:
          size: 1000000000